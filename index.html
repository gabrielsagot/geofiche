<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Carte interactive des établissements avec filtres avancés et statistiques">
    <meta name="theme-color" content="#2563eb">
    <title>Carte des Établissements</title>
    
    <!-- Preconnect pour optimiser le chargement des CDN -->
    <link rel="preconnect" href="https://cdnjs.cloudflare.com">
    <link rel="preconnect" href="https://cdn.jsdelivr.net">
    
    <!-- Leaflet -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" integrity="sha512-h9FcoyWjHcOcmEVkxOfTLnmZFWIH0iZhZT1H2TbOq55xssQGEJHEaIm+PgoUaZbRvQTNTluNOEfb1ZRy6D3BOw==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js" integrity="sha512-puJW3E/qXDqYp9IfhAI54BJEaWIfloJ7JWs7OeD5i6ruC9JZL1gERT1wjtwXFlh7CjE7ZJ+/vcRZRkIYIb6p4g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- Leaflet MarkerCluster -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/MarkerCluster.Default.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.markercluster/1.5.1/leaflet.markercluster.min.js" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <!-- Leaflet Heat -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet.heat@0.2.0/dist/leaflet-heat.min.js" crossorigin="anonymous"></script>
    
    <!-- Chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js" integrity="sha512-ElRFoEQdI5Ht6kZvyzXhYG9NqjtkmlkfYk0wr6wHxU9JEHakS7UJZNeml5ALk+8IKlU6jDgMabC3vkumRokgJA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    
    <link rel="stylesheet" href="style.css">

    <!-- Auth Script (doit être chargé en premier) -->
    <script src="login.js"></script>
    <script>
        // Vérifier l'authentification avant de charger la page
        (function() {
            console.log('[Index] Checking authentication...');

            // Protection contre les boucles infinies
            const redirectCount = parseInt(sessionStorage.getItem('auth_redirect_count') || '0');
            if (redirectCount > 3) {
                console.error('[Index] Too many redirects, clearing session');
                sessionStorage.removeItem('auth_redirect_count');
                if (window.authUtils) {
                    window.authUtils.clearSession();
                }
                alert('Erreur d\'authentification. Veuillez vous reconnecter.');
                window.location.href = 'login.html';
                return;
            }

            // Vérifier si authUtils est disponible
            if (!window.authUtils) {
                console.error('[Index] authUtils not available');
                sessionStorage.setItem('auth_redirect_count', (redirectCount + 1).toString());
                window.location.href = 'login.html';
                return;
            }

            // Vérifier la session
            const isValid = window.authUtils.isSessionValid();
            console.log('[Index] Session valid:', isValid);

            if (!isValid) {
                console.log('[Index] Redirecting to login...');
                sessionStorage.setItem('auth_redirect_count', (redirectCount + 1).toString());
                window.location.href = 'login.html';
            } else {
                // Session valide, réinitialiser le compteur
                sessionStorage.removeItem('auth_redirect_count');
                console.log('[Index] Authentication successful');
            }
        })();
    </script>
</head>
<body>
    <!-- Loader avec meilleur support accessibilité -->
    <div class="loader" id="loadingOverlay" role="status" aria-live="polite" aria-hidden="true">
        <div class="spinner" aria-label="Chargement en cours"></div>
        <span class="sr-only">Chargement des données...</span>
    </div>
    
    <div class="container">
        <!-- Carte principale -->
        <div id="map" role="application" aria-label="Carte interactive des établissements"></div>
        <button class="sidebar-toggle collapsed-toggle" id="sidebarCollapsedToggle" aria-label="Afficher les filtres" aria-hidden="true" title="Afficher les filtres">
            ◀
        </button>
        
        <!-- Barre latérale des filtres -->
        <aside class="sidebar" role="complementary" aria-label="Panneau de filtres">
            <div class="sidebar-header">
                <div class="sidebar-title">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    <span>Filtres</span>
                </div>
                <div class="sidebar-header-actions">
                    <button class="btn-logout" id="logoutBtn" aria-label="Se déconnecter" title="Se déconnecter">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                            <polyline points="16 17 21 12 16 7"></polyline>
                            <line x1="21" y1="12" x2="9" y2="12"></line>
                        </svg>
                    </button>
                    <button class="sidebar-toggle" id="sidebarToggle" aria-label="Masquer/Afficher les filtres" aria-expanded="true" title="Basculer le panneau">
                        <span class="toggle-icon">◀</span>
                    </button>
                </div>
            </div>
            
            <div class="sidebar-content">
                <!-- Compteurs statistiques -->
                <div class="stats-counter" role="status" aria-live="polite">
                    <div class="stat-item">
                        <svg class="stat-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                            <polyline points="9 22 9 12 15 12 15 22"></polyline>
                        </svg>
                        <div class="stat-value" id="totalCount" aria-label="Nombre total d'établissements">0</div>
                        <div class="stat-label">Total</div>
                    </div>
                    <div class="stat-item">
                        <svg class="stat-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M1 12s4-7 11-7 11 7 11 7-4 7-11 7-11-7-11-7z"></path>
                            <circle cx="12" cy="12" r="3"></circle>
                        </svg>
                        <div class="stat-value" id="filteredCount" aria-label="Nombre d'établissements affichés">0</div>
                        <div class="stat-label">Affichés</div>
                    </div>
                    <div class="stat-item">
                        <svg class="stat-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="9" cy="7" r="4"></circle>
                            <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                            <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                        </svg>
                        <div class="stat-value" id="totalEmployees" aria-label="Nombre total de salariés concernés">0</div>
                        <div class="stat-label">Salariés total</div>
                    </div>
                    <div class="stat-item">
                        <svg class="stat-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                            <circle cx="8.5" cy="7" r="4"></circle>
                            <polyline points="17 11 19 13 23 9"></polyline>
                        </svg>
                        <div class="stat-value" id="filteredEmployees" aria-label="Nombre de salariés concernés affichés">0</div>
                        <div class="stat-label">Salariés affichés</div>
                    </div>
                </div>

                <!-- ========== SECTION 1 : ENTREPRISES ========== -->
                <div class="filter-section">
                    <div class="filter-section-header" onclick="toggleSection(this)">
                        <div class="filter-section-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            Entreprises
                        </div>
                        <div class="filter-section-toggle">−</div>
                    </div>
                    <div class="filter-section-content">

                    <!-- Recherche textuelle intelligente -->
                    <div class="filter-group">
                        <label class="filter-label" for="searchInput">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="11" cy="11" r="8"></circle>
                                <path d="m21 21-4.35-4.35"></path>
                            </svg>
                            Recherche Multi-Critères
                        </label>
                        <div class="smart-search-container">
                            <div class="search-tags" id="searchTags"></div>
                            <input
                                type="text"
                                id="searchInput"
                                class="filter-input smart-search-input"
                                placeholder="Code NAF ; Adresse ; Établissement..."
                                autocomplete="off"
                                aria-describedby="searchHelp">
                        </div>
                        <small id="searchHelp" class="filter-help">
                            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M12 16v-4M12 8h.01"></path>
                            </svg>
                            Utilisez <strong>";"</strong> pour séparer plusieurs critères de recherche (recherche ET)
                        </small>
                    </div>

                    <!-- Statut -->
                    <div class="filter-group">
                        <label class="filter-label" for="filterActif">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <path d="M9 12l2 2 4-4"></path>
                            </svg>
                            Statut
                        </label>
                        <select id="filterActif" class="filter-select" aria-label="Filtrer par statut">
                            <option value="">Tous les statuts</option>
                        </select>
                    </div>

                    <!-- Type établissement -->
                    <div class="filter-group">
                        <label class="filter-label" for="filterTypeEtab">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="9" y1="3" x2="9" y2="21"></line>
                            </svg>
                            Type établissement
                        </label>
                        <select id="filterTypeEtab" class="filter-select" aria-label="Filtrer par type d'établissement">
                            <option value="">Tous les types</option>
                        </select>
                    </div>

                    <!-- Médecin référent -->
                    <div class="filter-group">
                        <label class="filter-label" for="filterMedecin">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
                            </svg>
                            Médecin référent
                        </label>
                        <select id="filterMedecin" class="filter-select" aria-label="Filtrer par médecin référent">
                            <option value="">Tous les médecins</option>
                        </select>
                    </div>

                    <!-- Catégorie effectif -->
                    <div class="filter-group">
                        <label class="filter-label" for="filterCatEff">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="9" cy="7" r="4"></circle>
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                            </svg>
                            Catégorie effectif
                        </label>
                        <select id="filterCatEff" class="filter-select" aria-label="Filtrer par catégorie d'effectif">
                            <option value="">Toutes les catégories</option>
                        </select>
                    </div>

                    <!-- Nombre d'individus suivis -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="8" y1="6" x2="21" y2="6"></line>
                                <line x1="8" y1="12" x2="21" y2="12"></line>
                                <line x1="8" y1="18" x2="21" y2="18"></line>
                                <line x1="3" y1="6" x2="3.01" y2="6"></line>
                                <line x1="3" y1="12" x2="3.01" y2="12"></line>
                                <line x1="3" y1="18" x2="3.01" y2="18"></line>
                            </svg>
                            Nombre d'individus suivis
                        </label>
                        <div class="range-inputs">
                            <input type="number" id="minIndividus" class="range-input" placeholder="Min" aria-label="Nombre minimum d'individus">
                            <span class="range-separator" aria-hidden="true">-</span>
                            <input type="number" id="maxIndividus" class="range-input" placeholder="Max" aria-label="Nombre maximum d'individus">
                        </div>
                    </div>

                    <!-- Date adhésion établissement -->
                    <div class="filter-group">
                        <label class="filter-label" for="minDateAdh">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Date adhésion établissement
                        </label>
                        <div class="date-range">
                            <input type="date" id="minDateAdh" class="range-input" aria-label="Date d'adhésion à partir de">
                            <input type="date" id="maxDateAdh" class="range-input" aria-label="Date d'adhésion jusqu'à">
                        </div>
                    </div>

                    <!-- Niveau de risque -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                <line x1="12" y1="9" x2="12" y2="13"></line>
                                <line x1="12" y1="17" x2="12.01" y2="17"></line>
                            </svg>
                            Niveau de risque
                        </label>
                        <div class="risk-filter-buttons">
                            <button type="button" class="risk-btn" data-risk="1" title="Risque très faible">
                                <span class="risk-number">1</span>
                                <span class="risk-text">Très faible</span>
                            </button>
                            <button type="button" class="risk-btn" data-risk="2" title="Risque faible">
                                <span class="risk-number">2</span>
                                <span class="risk-text">Faible</span>
                            </button>
                            <button type="button" class="risk-btn" data-risk="3" title="Risque moyen">
                                <span class="risk-number">3</span>
                                <span class="risk-text">Moyen</span>
                            </button>
                            <button type="button" class="risk-btn" data-risk="4" title="Risque élevé">
                                <span class="risk-number">4</span>
                                <span class="risk-text">Élevé</span>
                            </button>
                        </div>
                        <input type="hidden" id="minRisque">
                        <input type="hidden" id="maxRisque">
                    </div>

                    <!-- Secteur référent -->
                    <div class="filter-group">
                        <label class="filter-label" for="filterSecteur">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            Secteur référent
                        </label>
                        <select id="filterSecteur" class="filter-select" aria-label="Filtrer par secteur référent">
                            <option value="">Tous les secteurs</option>
                        </select>
                    </div>

                    <!-- Niveau adhésion -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <polyline points="17 11 19 13 23 9"></polyline>
                            </svg>
                            Niveau adhésion
                        </label>
                        <div class="range-inputs">
                            <input type="number" id="minNivAdh" class="range-input" placeholder="Niveau min" aria-label="Niveau d'adhésion minimum">
                            <input type="number" id="maxNivAdh" class="range-input" placeholder="Niveau max" aria-label="Niveau d'adhésion maximum">
                        </div>
                    </div>

                    <!-- Index catégorie effectif -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="2" y1="20" x2="22" y2="20"></line>
                                <rect x="3" y="12" width="4" height="8"></rect>
                                <rect x="9" y="8" width="4" height="12"></rect>
                                <rect x="15" y="4" width="4" height="16"></rect>
                            </svg>
                            Index catégorie effectif
                        </label>
                        <div class="range-inputs">
                            <input type="number" id="minIndex" class="range-input" placeholder="Index min" aria-label="Index minimum">
                            <input type="number" id="maxIndex" class="range-input" placeholder="Index max" aria-label="Index maximum">
                        </div>
                    </div>

                    </div>
                </div>

                <!-- ========== SECTION 2 : FICHES D'ENTREPRISES ========== -->
                <div class="filter-section">
                    <div class="filter-section-header" onclick="toggleSection(this)">
                        <div class="filter-section-title">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                            </svg>
                            Fiches d'Entreprises
                        </div>
                        <div class="filter-section-toggle">−</div>
                    </div>
                    <div class="filter-section-content">

                    <!-- Case Sans FE - IMPORTANT -->
                    <div class="filter-group highlight-box">
                        <div class="toggle-group sans-fe-toggle">
                            <input type="checkbox" id="filterSansFE">
                            <label for="filterSansFE" class="sans-fe-label">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                                    <line x1="12" y1="9" x2="12" y2="13"></line>
                                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                                </svg>
                                <strong>Sans Fiche d'Entreprise</strong>
                            </label>
                        </div>
                        <small class="filter-help">Afficher uniquement les entreprises sans fiche d'entreprise</small>
                    </div>

                    <!-- Âge de la FE -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="10"></circle>
                                <polyline points="12 6 12 12 16 14"></polyline>
                            </svg>
                            Âge FE (années)
                        </label>
                        <div class="range-inputs">
                            <input type="number" id="minAge" class="range-input" placeholder="Âge minimum" step="0.01" aria-label="Âge minimum">
                            <input type="number" id="maxAge" class="range-input" placeholder="Âge maximum" step="0.01" aria-label="Âge maximum">
                        </div>
                    </div>

                    <!-- Créateur de la FE -->
                    <div class="filter-group">
                        <label class="filter-label" for="filterCreateurFE">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                                <circle cx="8.5" cy="7" r="4"></circle>
                                <polyline points="17 11 19 13 23 9"></polyline>
                            </svg>
                            Créateur de la FE
                        </label>
                        <select id="filterCreateurFE" class="filter-select" aria-label="Filtrer par créateur de la FE">
                            <option value="">Tous les créateurs</option>
                        </select>
                    </div>

                    <!-- Dernière personne à avoir mis à jour la FE -->
                    <div class="filter-group">
                        <label class="filter-label" for="filterMajFE">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            Dernière MAJ par
                        </label>
                        <select id="filterMajFE" class="filter-select" aria-label="Filtrer par personne ayant mis à jour la FE">
                            <option value="">Toutes les personnes</option>
                        </select>
                    </div>

                    <!-- Priorité proposée -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon>
                            </svg>
                            Priorité proposée
                        </label>
                        <div class="range-inputs">
                            <input type="number" id="minPrioProp" class="range-input" placeholder="Priorité min" aria-label="Priorité proposée minimum">
                            <input type="number" id="maxPrioProp" class="range-input" placeholder="Priorité max" aria-label="Priorité proposée maximum">
                        </div>
                    </div>

                    <!-- Intervenant prévu -->
                    <div class="filter-group">
                        <label class="filter-label" for="filterIntervenant">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                <circle cx="12" cy="7" r="4"></circle>
                            </svg>
                            Intervenant prévu
                        </label>
                        <select id="filterIntervenant" class="filter-select" aria-label="Filtrer par intervenant prévu">
                            <option value="">Tous les intervenants</option>
                        </select>
                    </div>

                    <!-- Rédacteur de la FE -->
                    <div class="filter-group">
                        <label class="filter-label" for="filterRedacteur">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                            </svg>
                            Rédacteur de la FE
                        </label>
                        <select id="filterRedacteur" class="filter-select" aria-label="Filtrer par rédacteur">
                            <option value="">Tous les rédacteurs</option>
                        </select>
                    </div>

                    <!-- Année prévue -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Année prévue
                        </label>
                        <div class="range-inputs">
                            <input type="number" id="minAnnee" class="range-input" placeholder="Année min" aria-label="Année minimum">
                            <input type="number" id="maxAnnee" class="range-input" placeholder="Année max" aria-label="Année maximum">
                        </div>
                    </div>

                    <!-- Trimestre prévu -->
                    <div class="filter-group">
                        <label class="filter-label">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
                                <circle cx="12" cy="10" r="3"></circle>
                            </svg>
                            Trimestre prévu
                        </label>
                        <div class="range-inputs">
                            <input type="number" id="minTrimestre" class="range-input" placeholder="Trimestre min (1-4)" min="1" max="4" aria-label="Trimestre minimum">
                            <input type="number" id="maxTrimestre" class="range-input" placeholder="Trimestre max (1-4)" min="1" max="4" aria-label="Trimestre maximum">
                        </div>
                    </div>

                    <!-- Condition réalisation -->
                    <div class="filter-group">
                        <label class="filter-label" for="filterCondition">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            Condition réalisation
                        </label>
                        <select id="filterCondition" class="filter-select" aria-label="Filtrer par condition de réalisation">
                            <option value="">Toutes les conditions</option>
                        </select>
                    </div>

                    <!-- Suite FE -->
                    <div class="filter-group">
                        <label class="filter-label" for="filterSuite">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <polyline points="9 11 12 14 22 4"></polyline>
                                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
                            </svg>
                            Suite FE
                        </label>
                        <select id="filterSuite" class="filter-select" aria-label="Filtrer par suite FE">
                            <option value="">Toutes les suites</option>
                        </select>
                    </div>

                    <!-- Date création fiche entreprise -->
                    <div class="filter-group">
                        <label class="filter-label" for="minDateCrea">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                                <line x1="12" y1="14" x2="12" y2="18"></line>
                                <line x1="10" y1="16" x2="14" y2="16"></line>
                            </svg>
                            Date création fiche entreprise
                        </label>
                        <div class="date-range">
                            <input type="date" id="minDateCrea" class="range-input" aria-label="Date de création à partir de">
                            <input type="date" id="maxDateCrea" class="range-input" aria-label="Date de création jusqu'à">
                        </div>
                    </div>

                    <!-- Date mise à jour fiche entreprise -->
                    <div class="filter-group">
                        <label class="filter-label" for="minDateMaj">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                            </svg>
                            Date mise à jour fiche entreprise
                        </label>
                        <div class="date-range">
                            <input type="date" id="minDateMaj" class="range-input" aria-label="Date de mise à jour à partir de">
                            <input type="date" id="maxDateMaj" class="range-input" aria-label="Date de mise à jour jusqu'à">
                        </div>
                    </div>

                    <!-- Date envoi FE adhérent -->
                    <div class="filter-group">
                        <label class="filter-label" for="minDateEnvoi">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                            Date envoi FE adhérent
                        </label>
                        <div class="date-range">
                            <input type="date" id="minDateEnvoi" class="range-input" aria-label="Date d'envoi à partir de">
                            <input type="date" id="maxDateEnvoi" class="range-input" aria-label="Date d'envoi jusqu'à">
                        </div>
                    </div>

                    </div>
                </div>

                <!-- Options de visualisation -->
                <div class="filter-group">
                    <div class="toggle-group">
                        <input type="checkbox" id="toggleClustering" checked>
                        <label for="toggleClustering">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <circle cx="12" cy="12" r="3"></circle>
                                <circle cx="19" cy="5" r="2"></circle>
                                <circle cx="5" cy="19" r="2"></circle>
                                <circle cx="19" cy="19" r="2"></circle>
                            </svg>
                            Clustering
                        </label>
                    </div>
                    <div class="toggle-group">
                        <input type="checkbox" id="toggleHeatmap">
                        <label for="toggleHeatmap">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 2v20M2 12h20"></path>
                                <circle cx="12" cy="12" r="4"></circle>
                            </svg>
                            Heatmap
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Pied de page avec boutons d'action -->
            <div class="sidebar-footer">
                <button class="btn btn-primary btn-small" id="applyBtn" aria-label="Appliquer les filtres">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Appliquer
                </button>
                <button class="btn btn-secondary btn-small" id="resetBtn" aria-label="Réinitialiser les filtres" title="Effacer tous les filtres">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path>
                        <path d="M21 3v5h-5"></path>
                        <path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path>
                        <path d="M3 21v-5h5"></path>
                    </svg>
                    Réinit.
                </button>
                <button class="btn btn-secondary btn-small" id="statsBtn" aria-label="Afficher les statistiques">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="12" y1="20" x2="12" y2="10"></line>
                        <line x1="18" y1="20" x2="18" y2="4"></line>
                        <line x1="6" y1="20" x2="6" y2="16"></line>
                    </svg>
                    Stats
                </button>
                <button class="btn btn-secondary btn-small" id="exportBtn" aria-label="Exporter les données">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export
                </button>
            </div>
        </aside>
    </div>
    
    <!-- Modal des statistiques -->
    <div class="modal" id="statsModal" role="dialog" aria-labelledby="statsModalTitle" aria-modal="true" aria-hidden="true">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="statsModalTitle">Statistiques</h2>
                <button class="modal-close" onclick="document.getElementById('statsModal').classList.remove('active')" aria-label="Fermer la fenêtre des statistiques">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body" id="statsBody" role="document">
                <p class="loading-message">Chargement des statistiques...</p>
            </div>
        </div>
    </div>

    <!-- Modal d'export -->
    <div class="modal" id="exportModal" role="dialog" aria-labelledby="exportModalTitle" aria-modal="true" aria-hidden="true">
        <div class="modal-content export-modal-content">
            <div class="modal-header">
                <h2 id="exportModalTitle">Exporter les données</h2>
                <button class="modal-close" id="exportModalClose" aria-label="Fermer la fenêtre d'export">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p class="export-description">Choisissez le format d'export pour vos données filtrées</p>
                <div class="export-options">
                    <button class="export-option" id="exportCSVBtn" data-format="csv">
                        <div class="export-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                        </div>
                        <div class="export-info">
                            <h3>CSV</h3>
                            <p>Format tableur compatible Excel, Google Sheets</p>
                        </div>
                    </button>
                    <button class="export-option" id="exportGeoJSONBtn" data-format="geojson">
                        <div class="export-icon">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <circle cx="12" cy="13" r="2"></circle>
                                <path d="M12 11V9"></path>
                                <path d="M12 17v-2"></path>
                                <path d="M10 13H8"></path>
                                <path d="M16 13h-2"></path>
                            </svg>
                        </div>
                        <div class="export-info">
                            <h3>GeoJSON</h3>
                            <p>Format géographique pour SIG et applications cartographiques</p>
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>
    

    <!-- Scripts -->
    <script src="script.js"></script>
</body>
</html>
